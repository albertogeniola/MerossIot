

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Advanced topics &mdash; MerossIot Library  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  

  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
        <script data-ad-client="ca-pub-9110025741700767" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Meross Protocol Inspection" href="meross-protocol.html" />
    <link rel="prev" title="Common gotchas" href="common-gotchas.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="index.html" class="icon icon-home"> MerossIot Library
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="quick-start.html">Quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="common-gotchas.html">Common gotchas</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Advanced topics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#push-notification-handling">Push notification handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#managing-rate-limits">Managing rate limits</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mqtt-calls-statistics">MQTT Calls Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#logging">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sniff-device-data">Sniff device data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="meross-protocol.html">Meross Protocol Inspection</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-reference/index.html">API Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MerossIot Library</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Advanced topics</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/advanced-topics.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="advanced-topics">
<h1>Advanced topics<a class="headerlink" href="#advanced-topics" title="Permalink to this headline">¶</a></h1>
<div class="section" id="push-notification-handling">
<h2>Push notification handling<a class="headerlink" href="#push-notification-handling" title="Permalink to this headline">¶</a></h2>
<p>The current library allows a developer to catch and react to events that occur on a specific device.
The <code class="code docutils literal notranslate"><span class="pre">BaseDevice</span></code> class exposes the <code class="code docutils literal notranslate"><span class="pre">register_push_notification_handler_coroutine()</span></code> method, which
allows to register an async coroutine to be executed when an push notification is received for that device.
The registered coroutine signature must match the following signature:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ... OMISSIS ...</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">coro_name</span><span class="p">(</span><span class="n">namespace</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">device_internal_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># TODO: do something with event data</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>The push notification handler can be de-registered via the <code class="code docutils literal notranslate"><span class="pre">unregister_push_notification_handler_coroutine()</span></code>
method, which takes as input the coroutine to unregister.</p>
<p>Similarly, it is possible to intercept all the push notifications received for all the devices, by registering a push
notification coroutine handler to the <code class="code docutils literal notranslate"><span class="pre">MerossManager</span></code> instance. This can be done using the
<code class="code docutils literal notranslate"><span class="pre">register_push_notification_handler_coroutine()</span></code> method and passing a coroutine definition that matches the
following signature:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ... OMISSIS ...</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">evt_coro</span><span class="p">(</span><span class="n">namespace</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">device_internal_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># TODO: do something with event data</span>
    <span class="k">pass</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Failure to comply with the given signature will prevent the event handler from executing.
Be sure to stick with the exact method signature.</p>
</div>
<p>Again, it is possible to de-register such push notification handlers by invoking the
<code class="code docutils literal notranslate"><span class="pre">unregister_push_notification_handler_coroutine()</span></code> and passing the coroutine to unregister</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For long-running and deamon like scripts, you should limit the number of registered push notificaiton handlers
and you should unregister when they are no more needed.</p>
</div>
</div>
<div class="section" id="managing-rate-limits">
<h2>Managing rate limits<a class="headerlink" href="#managing-rate-limits" title="Permalink to this headline">¶</a></h2>
<p>The latest version of MerossManager does not implement any mqtt rate limiting out-of-the-box, but allows the
developer to control how mqtt calls are issued to the Meross broker. To do so, simply set the value of the
<cite>rate_limiter</cite> property of the <cite>MerossManager</cite> object. You can use the <cite>RateLimitChecker</cite> helper class
as shown below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ... OMISSIS ...</span>
<span class="c1"># Look for a device to be used for this test</span>
<span class="n">meross_client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">MerossHttpClient</span><span class="o">.</span><span class="n">async_from_user_password</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">EMAIL</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">PASSWORD</span><span class="p">,</span> <span class="o">**</span><span class="n">opt_params</span><span class="p">)</span>
<span class="n">rate_limiter</span> <span class="o">=</span> <span class="n">RateLimitChecker</span><span class="p">(</span><span class="n">global_time_window</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">global_burst_rate</span><span class="o">=</span><span class="n">BURST_RATE</span><span class="p">,</span> <span class="n">device_max_command_queue</span><span class="o">=</span><span class="n">BURST_RATE</span><span class="p">)</span>
<span class="n">manager</span> <span class="o">=</span> <span class="n">MerossManager</span><span class="p">(</span><span class="n">http_client</span><span class="o">=</span><span class="n">meross_client</span><span class="p">,</span> <span class="n">rate_limiter</span><span class="o">=</span><span class="n">rate_limiter</span><span class="p">)</span>
</pre></div>
</div>
<p>The current implementation of rate limits is based on a <em>global</em> rate limiter and on a <em>per device</em> rate limiter.
Both limit checks are based on the <a class="reference external" href="https://it.wikipedia.org/wiki/Token_bucket">Token bucket policy</a> and
the developer can set them up when building the <cite>MerossManager</cite> object.</p>
<p>Each command issued by the manager is first checked against the per-device rate limiter.
If that limit is not reached hit, then a second check is performed against the global rate limiter.
If both the checks pass, then the command is issued to the broker.</p>
<p>In case any of the two limits is hit, the Manager will reschedule the command (retrying) with an exponential backoff
strategy. The command is retried (delayed) until the number of retries exceeds the device_max_command_queue
parameter value. When this happens, the current call and the future calls are dropped, until new tokens are added
to the bucket.</p>
</div>
<div class="section" id="mqtt-calls-statistics">
<h2>MQTT Calls Statistics<a class="headerlink" href="#mqtt-calls-statistics" title="Permalink to this headline">¶</a></h2>
<p>The <cite>MerossManager</cite> tracks some statistics about MQTT messages sent to the broker, useful to better tune
the API rate limits. You can access such statistics via <cite>MerossManager.mqtt_call_stats()</cite>, which returns an
instance of <cite>ApiCounter</cite> class, which exposes convenient methods to retrieve performed calls, delayed ones and
dropped ones.</p>
<p>At the moment, the ApiCounter keeps track of the latest 1000 mqtt calls performed.
Statistics are calculated over a timewindow of 1 minute: you can override the timewindow size
by setting the <cite>time_window</cite> parameter accordingly (pass a <cite>timedelta</cite>).</p>
<p>For more info, please refer to the API reference of <cite>MerossManager</cite> and <cite>ApiCounter</cite> classes.</p>
</div>
<div class="section" id="logging">
<h2>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h2>
<p>This library relies on the standard Python’s logging module.
It is possible to control the logging verbosity by modifying the severity of meross_iot log level, as shown
in the following example.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">meross_iot.http_api</span> <span class="kn">import</span> <span class="n">MerossHttpClient</span>
<span class="kn">from</span> <span class="nn">meross_iot.manager</span> <span class="kn">import</span> <span class="n">MerossManager</span>


<span class="n">meross_root_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;meross_iot&quot;</span><span class="p">)</span>
<span class="n">meross_root_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
</pre></div>
</div>
<p>That code snippet will raise the log-level to WARNING, so DEBUG and INFO messages are not logged any longer.</p>
</div>
<div class="section" id="sniff-device-data">
<h2>Sniff device data<a class="headerlink" href="#sniff-device-data" title="Permalink to this headline">¶</a></h2>
<p>Meross is continuously releasing new smart devices on the market.
The library has been developed in order to automatically discover and support most of the basic
functions that such devices expose. However, as new devices are released by Meross, also new feature may arise.
In such cases, you may collect low-level data using a specific sniffing tool: <cite>meross_sniffer</cite>.</p>
<p>The sniffing tool basically listens for commands that the Meross App sends to the device and registers its “responses”.
In this way, one can use the sniffer tool to collect the data exchanged by the Meross App and the device.</p>
<p>The tool is pretty easy to use: run the program, select the device you want to sniff data from and start to
play with the devide from the Meross App. Once you have tested the feature of interest, wait a bit and then
press ENTER to stop the sniffer. The collected data will be zipped into a folder named data.zip, that you may upload
on github in order to support the feature implementation.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Even though the sniffing utility has been designed to not gather user’s credentials, there is no
way to make sure the Meross App does not send sensitive information over the network. For this reason,
you should always change your password before using this utility. It’s strongly advised to create an ad-hoc
account for this matter.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In case you decide to use a dedicated Meross account for the sniffing tool, make sure to remove the device
you want to sniff from your original account and add it to your new account, which you will use for the sniffing.</p>
</div>
<p>In order to use the sniffing tool, perform the following:</p>
<ul>
<li><p>Create a new Meross Account to use for the sniffing tool (alternatively, change the password of your current account)</p></li>
<li><p>Make sure the device you want to sniff data from/to is added to your Meross Account and is ON and ONLINE</p></li>
<li><p>Start the MerossSniffing tool (with the following command)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>meross_sniffer
</pre></div>
</div>
</li>
<li><p>Log-in with your Meross credentials</p></li>
<li><p>Select the device you want to gather info from and make sure its reported status is ONLINE</p></li>
<li><p>Play with the device using the Meross App: make sure to test all the features of the device if that device is not yet supported by the MerossIot library</p></li>
<li><p>Once done, press ENTER</p></li>
<li><p>Upload the <em>data.zip</em> file that was generated in the directory where the utility has been run</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="meross-protocol.html" class="btn btn-neutral float-right" title="Meross Protocol Inspection" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="common-gotchas.html" class="btn btn-neutral float-left" title="Common gotchas" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Alberto Geniola.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-10387182-6', 'auto');
    
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>